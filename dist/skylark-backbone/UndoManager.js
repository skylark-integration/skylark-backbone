/**
 * skylark-backbone - A version of backbone that ported to running on skylarkjs.
 * @author 
 * @version v0.9.0
 * @link 
 * @license MIT
 */
define(["skylark-langx/langx","skylark-underscore/underscore","./backbone","./Model","./Collection"],function(t,e,n,i,r){var o=Array.prototype.slice;function s(t,e,n){return n.length<=4?t.call(e,n[0],n[1],n[2],n[3]):t.apply(e,n)}function c(t,e){return o.call(t,e)}function u(t,n){return null!=t&&(e.isArray(n)||(n=c(arguments,1)),e.all(n,function(e){return e in t}))}var a=function(){var t=!1,n=-1;return function(){return t||(n++,t=!0,e.defer(function(){t=!1})),n}}();function d(){this.registeredObjects=[],this.cidIndexes=[]}function f(t,n,i,r){for(var o,s=0,c=n.length;s<c;s++)if(o=n[s]){if("on"===t){if(!r.objectRegistry.register(o))continue}else if(!r.objectRegistry.unregister(o))continue;e.isFunction(o[t])&&o[t]("all",i,r)}}function h(t,n){var i=n.type,r=n.undoTypes,o=!r[i]||r[i][t];e.isFunction(o)&&o(n.object,n.before,n.after,n.options)}function g(t,n,i,r,s){if(!(i.isCurrentlyUndoRedoing||"undo"===t&&-1===i.pointer||"redo"===t&&i.pointer===i.length-1)){i.isCurrentlyUndoRedoing=!0;var c,u,a="undo"===t;for(s?u=a&&i.pointer===i.length-1||!a&&-1===i.pointer?e.clone(i.models):o.apply(i.models,a?[0,i.pointer]:[i.pointer,i.length-1]):(c=i.at(a?i.pointer:i.pointer+1),u=r?i.where({magicFusionIndex:c.get("magicFusionIndex")}):[c]),i.pointer+=(a?-1:1)*u.length;c=a?u.pop():u.shift();)c[t]();i.isCurrentlyUndoRedoing=!1,n.trigger(t,n)}}function l(t,e,n,i){if(t.track&&!t.isCurrentlyUndoRedoing&&e in i&&function(t,e){var n=t.condition,i=typeof n;return"function"===i?!!s(n,t,e):"boolean"!==i||n}(i[e],n)){var r=s(i[e].on,i[e],n);if(u(r,"object","before","after")){if(r.type=e,r.magicFusionIndex=a(),r.undoTypes=i,t.pointer<t.length-1)for(var o=t.length-t.pointer-1;o--;)t.pop();t.pointer=t.length,t.add(r),t.length>t.maximumStackLength&&(t.shift(),t.pointer--)}}}d.prototype={isRegistered:function(t){return t&&t.cid?this.registeredObjects[t.cid]:e.contains(this.registeredObjects,t)},register:function(t){return!this.isRegistered(t)&&(t&&t.cid?(this.registeredObjects[t.cid]=t,this.cidIndexes.push(t.cid)):this.registeredObjects.push(t),!0)},unregister:function(t){if(this.isRegistered(t)){if(t&&t.cid)delete this.registeredObjects[t.cid],this.cidIndexes.splice(e.indexOf(this.cidIndexes,t.cid),1);else{var n=e.indexOf(this.registeredObjects,t);this.registeredObjects.splice(n,1)}return!0}return!1},get:function(){return e.map(this.cidIndexes,function(t){return this.registeredObjects[t]},this).concat(this.registeredObjects)}};var p={add:{undo:function(t,e,n,i){t.remove(n,i)},redo:function(t,e,n,i){i.index&&(i.at=i.index),t.add(n,i)},on:function(t,n,i){return{object:n,before:void 0,after:t,options:e.clone(i)}}},remove:{undo:function(t,e,n,i){"index"in i&&(i.at=i.index),t.add(e,i)},redo:function(t,e,n,i){t.remove(e,i)},on:function(t,n,i){return{object:n,before:t,after:void 0,options:e.clone(i)}}},change:{undo:function(t,n,i,r){e.isEmpty(n)?e.each(e.keys(i),t.unset,t):(t.set(n),r&&r.unsetData&&r.unsetData.before&&r.unsetData.before.length&&e.each(r.unsetData.before,t.unset,t))},redo:function(t,n,i,r){e.isEmpty(i)?e.each(e.keys(n),t.unset,t):(t.set(i),r&&r.unsetData&&r.unsetData.after&&r.unsetData.after.length&&e.each(r.unsetData.after,t.unset,t))},on:function(t,n){var i=t.changedAttributes(),r=e.keys(i),o=e.pick(t.previousAttributes(),r),s=e.keys(o),c=(n||(n={})).unsetData={after:[],before:[]};return r.length!=s.length&&(r.length>s.length?e.each(r,function(t){t in o||c.before.push(t)},this):e.each(s,function(t){t in i||c.after.push(t)})),{object:t,before:o,after:i,options:e.clone(n)}}},reset:{undo:function(t,e,n){t.reset(e)},redo:function(t,e,n){t.reset(n)},on:function(t,n){return{object:t,before:n.previousModels,after:e.clone(t.models)}}}};function k(){}function b(t,n,i,r){if("object"==typeof n)return e.each(n,function(e,n){2===t?b(t,e,i,r):b(t,n,e,i)});switch(t){case 0:u(i,"undo","redo","on")&&e.all(e.pick(i,"undo","redo","on"),e.isFunction)&&(r[n]=i);break;case 1:r[n]&&e.isObject(i)&&(r[n]=e.extend({},r[n],i));break;case 2:delete r[n]}return this}k.prototype=p;var y=i.extend({defaults:{type:null,object:null,before:null,after:null,magicFusionIndex:null},undo:function(t){h("undo",this.attributes)},redo:function(t){h("redo",this.attributes)}}),m=r.extend({model:y,pointer:-1,track:!1,isCurrentlyUndoRedoing:!1,maximumStackLength:1/0,setMaxLength:function(t){this.maximumStackLength=t}}),x=i.extend({defaults:{maximumStackLength:1/0,track:!1},initialize:function(t){this.stack=new m,this.objectRegistry=new d,this.undoTypes=new k,this.stack.setMaxLength(this.get("maximumStackLength")),this.on("change:maximumStackLength",function(t,e){this.stack.setMaxLength(e)},this),t&&t.track&&this.startTracking(),t&&t.register&&(e.isArray(t.register)||e.isArguments(t.register)?s(this.register,this,t.register):this.register(t.register))},startTracking:function(){this.set("track",!0),this.stack.track=!0},stopTracking:function(){this.set("track",!1),this.stack.track=!1},isTracking:function(){return this.get("track")},_addToStack:function(t){l(this.stack,t,c(arguments,1),this.undoTypes)},register:function(){f("on",arguments,this._addToStack,this)},unregister:function(){f("off",arguments,this._addToStack,this)},unregisterAll:function(){s(this.unregister,this,this.objectRegistry.get())},undo:function(t){g("undo",this,this.stack,t)},undoAll:function(){g("undo",this,this.stack,!1,!0)},redo:function(t){g("redo",this,this.stack,t)},redoAll:function(){g("redo",this,this.stack,!1,!0)},isAvailable:function(t){var e=this.stack,n=e.length;switch(t){case"undo":return n>0&&e.pointer>-1;case"redo":return n>0&&e.pointer<n-1;default:return!1}},merge:function(t){for(var n,i=e.isArray(t)?t:c(arguments);n=i.pop();)n instanceof x&&n.stack instanceof m&&(n.stack=this.stack)},addUndoType:function(t,e){b(0,t,e,this.undoTypes)},changeUndoType:function(t,e){b(1,t,e,this.undoTypes)},removeUndoType:function(t){b(2,t,void 0,this.undoTypes)},clear:function(){this.stack.reset(),this.stack.pointer=-1}});return e.extend(x,{defaults:function(t){e.extend(x.prototype.defaults,t)},addUndoType:function(t,e){b(0,t,e,p)},changeUndoType:function(t,e){b(1,t,e,p)},removeUndoType:function(t){b(2,t,void 0,p)}}),n.UndoManager=x});
//# sourceMappingURL=sourcemaps/UndoManager.js.map
