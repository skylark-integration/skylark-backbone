/**
 * skylark-backbone - A version of backbone that ported to running on skylarkjs.
 * @author 
 * @version v0.9.0
 * @link 
 * @license MIT
 */
define(["skylark-langx/langx"],function(t){var e={create:"POST",update:"PUT",patch:"PATCH",delete:"DELETE",read:"GET"},i=function(t,e){var i=e.error;e.error=function(n){i&&i.call(e.context,t,n,e),t.trigger("error",t,n,e)}},n=t.Stateful.inherit({sync:function(){return o.sync.apply(this,arguments)},matches:function(e){return t.isMatch(this.attributes,e)},fetch:function(e){var n=this,r=(e=t.mixin({parse:!0},e)).success;return e.success=function(t){var i=e.parse?n.parse(t,e):t;if(!n.set(i,e))return!1;r&&r.call(e.context,n,t,e),n.trigger("sync",n,t,e)},i(this,e),this.sync("read",this,e)},save:function(e,n,r){var s;null==e||"object"==typeof e?(s=e,r=n):(s={})[e]=n;var h=(r=t.mixin({validate:!0,parse:!0},r)).wait;if(s&&!h){if(!this.set(s,r))return!1}else if(!this._validate(s,r))return!1;var a=this,o=r.success,u=this.attributes;r.success=function(e){a.attributes=u;var i=r.parse?a.parse(e,r):e;if(h&&(i=t.mixin({},s,i)),i&&!a.set(i,r))return!1;o&&o.call(r.context,a,e,r),a.trigger("sync",a,e,r)},i(this,r),s&&h&&(this.attributes=t.mixin({},u,s));var c=this.isNew()?"create":r.patch?"patch":"update";"patch"!==c||r.attrs||(r.attrs=s);var l=this.sync(c,this,r);return this.attributes=u,l},destroy:function(e){var n=this,r=(e=e?t.clone(e):{}).success,s=e.wait,h=function(){n.stopListening(),n.trigger("destroy",n,n.collection,e)};e.success=function(t){s&&h(),r&&r.call(e.context,n,t,e),n.isNew()||n.trigger("sync",n,t,e)};var a=!1;return this.isNew()?t.defer(e.success):(i(this,e),a=this.sync("delete",this,e)),s||h(),a},url:function(){var e=t.result(this,"urlRoot")||t.result(this.collection,"url")||urlError();if(this.isNew())return e;var i=this.get(this.idAttribute);return e.replace(/[^\/]$/,"$&/")+encodeURIComponent(i)},parse:function(t,e){return t}}),r=t.Evented.inherit({_construct:function(e,i){i||(i={}),i.entity&&(this.entity=i.entity),void 0!==i.comparator&&(this.comparator=i.comparator),this._reset(),e&&this.reset(e,t.mixin({silent:!0},i))}}),s={add:!0,remove:!0,merge:!0},h={add:!0,remove:!1},a=function(t,e,i){i=Math.min(Math.max(i,0),t.length);var n,r=Array(t.length-i),s=e.length;for(n=0;n<r.length;n++)r[n]=t[n+i];for(n=0;n<s;n++)t[n+i]=e[n];for(n=0;n<r.length;n++)t[n+s+i]=r[n]};function o(){return o}return r.partial({entity:n,initialize:function(){},toJSON:function(t){return this.map(function(e){return e.toJSON(t)})},sync:function(){return o.sync.apply(this,arguments)},add:function(e,i){return this.set(e,t.mixin({merge:!1},i,h))},remove:function(e,i){i=t.mixin({},i);var n=!t.isArray(e);e=n?[e]:e.slice();var r=this._removeEntitys(e,i);return!i.silent&&r.length&&(i.changes={added:[],merged:[],removed:r},this.trigger("update",this,i)),n?r[0]:r},set:function(e,i){if(null!=e){(i=t.mixin({},s,i)).parse&&!this._isEntity(e)&&(e=this.parse(e,i)||[]);var n=!t.isArray(e);e=n?[e]:e.slice();var r=i.at;null!=r&&(r=+r),r>this.length&&(r=this.length),r<0&&(r+=this.length+1);var h,o,u=[],c=[],l=[],d=[],f={},g=i.add,p=i.merge,y=i.remove,v=!1,m=this.comparator&&null==r&&!1!==i.sort,_=t.isString(this.comparator)?this.comparator:null;for(o=0;o<e.length;o++){h=e[o];var E=this.get(h);if(E){if(p&&h!==E){var x=this._isEntity(h)?h.attributes:h;i.parse&&(x=E.parse(x,i)),E.set(x,i),l.push(E),m&&!v&&(v=E.hasChanged(_))}f[E.cid]||(f[E.cid]=!0,u.push(E)),e[o]=E}else g&&(h=e[o]=this._prepareEntity(h,i))&&(c.push(h),this._addReference(h,i),f[h.cid]=!0,u.push(h))}if(y){for(o=0;o<this.length;o++)f[(h=this.entities[o]).cid]||d.push(h);d.length&&this._removeEntitys(d,i)}var b=!1,T=!m&&g&&y;if(u.length&&T?(b=this.length!==u.length||this.entities.some(function(t,e){return t!==u[e]}),this.entities.length=0,a(this.entities,u,0),this.length=this.entities.length):c.length&&(m&&(v=!0),a(this.entities,c,null==r?this.length:r),this.length=this.entities.length),v&&this.sort({silent:!0}),!i.silent){for(o=0;o<c.length;o++)null!=r&&(i.index=r+o),(h=c[o]).trigger("add",h,this,i);(v||b)&&this.trigger("sort",this,i),(c.length||d.length||l.length)&&(i.changes={added:c,removed:d,merged:l},this.trigger("update",this,i))}return n?e[0]:e}},reset:function(e,i){i=i?t.clone(i):{};for(var n=0;n<this.entities.length;n++)this._removeReference(this.entities[n],i);return i.previousEntitys=this.entities,this._reset(),e=this.add(e,t.mixin({silent:!0},i)),i.silent||this.trigger("reset",this,i),e},push:function(e,i){return this.add(e,t.mixin({at:this.length},i))},pop:function(t){var e=this.at(this.length-1);return this.remove(e,t)},unshift:function(e,i){return this.add(e,t.mixin({at:0},i))},shift:function(t){var e=this.at(0);return this.remove(e,t)},slice:function(){return slice.apply(this.entities,arguments)},get:function(t){if(null!=t)return this._byId[t]||this._byId[this.entityId(t.attributes||t)]||t.cid&&this._byId[t.cid]},has:function(t){return null!=this.get(t)},at:function(t){return t<0&&(t+=this.length),this.entities[t]},where:function(t,e){return this[e?"find":"filter"](t)},findWhere:function(t){return this.where(t,!0)},sort:function(e){var i=this.comparator;if(!i)throw new Error("Cannot sort a set without a comparator");e||(e={});var n=i.length;return t.isFunction(i)&&(i=t.proxy(i,this)),1===n||t.isString(i)?this.entities=this.sortBy(i):this.entities.sort(i),e.silent||this.trigger("sort",this,e),this},pluck:function(t){return this.map(t+"")},fetch:function(e){var n=(e=t.mixin({parse:!0},e)).success,r=this;return e.success=function(t){var i=e.reset?"reset":"set";r[i](t,e),n&&n.call(e.context,r,t,e),r.trigger("sync",r,t,e)},i(this,e),this.sync("read",this,e)},create:function(e,i){var n=(i=i?t.clone(i):{}).wait;if(!(e=this._prepareEntity(e,i)))return!1;n||this.add(e,i);var r=this,s=i.success;return i.success=function(t,e,i){n&&r.add(t,i),s&&s.call(i.context,t,e,i)},e.save(null,i),e},parse:function(t,e){return t},clone:function(){return new this.constructor(this.entities,{entity:this.entity,comparator:this.comparator})},entityId:function(t){return t[this.entity.prototype.idAttribute||"id"]},_reset:function(){this.length=0,this.entities=[],this._byId={}},_prepareEntity:function(e,i){if(this._isEntity(e))return e.collection||(e.collection=this),e;(i=i?t.clone(i):{}).collection=this;var n=new this.entity(e,i);return n.validationError?(this.trigger("invalid",this,n.validationError,i),!1):n},_removeEntitys:function(t,e){for(var i=[],n=0;n<t.length;n++){var r=this.get(t[n]);if(r){var s=this.indexOf(r);this.entities.splice(s,1),this.length--,delete this._byId[r.cid];var h=this.entityId(r.attributes);null!=h&&delete this._byId[h],e.silent||(e.index=s,r.trigger("remove",r,this,e)),i.push(r),this._removeReference(r,e)}}return i},_isEntity:function(t){return t instanceof n},_addReference:function(t,e){this._byId[t.cid]=t;var i=this.entityId(t.attributes);null!=i&&(this._byId[i]=t),t.on("all",this._onEntityEvent,this)},_removeReference:function(t,e){delete this._byId[t.cid];var i=this.entityId(t.attributes);null!=i&&delete this._byId[i],this===t.collection&&delete t.collection,t.off("all",this._onEntityEvent,this)},_onEntityEvent:function(t,e,i,n){if(e){if(("add"===t||"remove"===t)&&i!==this)return;if("destroy"===t&&this.remove(e,n),"change"===t){var r=this.entityId(e.previousAttributes()),s=this.entityId(e.attributes);r!==s&&(null!=r&&delete this._byId[r],null!=s&&(this._byId[s]=e))}}this.trigger.apply(this,arguments)}}),t.mixin(o,{emulateHTTP:!1,emulateJSON:!1,sync:function(i,n,r){var s=e[i];t.defaults(r||(r={}),{emulateHTTP:o.emulateHTTP,emulateJSON:o.emulateJSON});var h={type:s,dataType:"json"};if(r.url||(h.url=t.result(n,"url")||urlError()),null!=r.data||!n||"create"!==i&&"update"!==i&&"patch"!==i||(h.contentType="application/json",h.data=JSON.stringify(r.attrs||n.toJSON(r))),r.emulateJSON&&(h.contentType="application/x-www-form-urlencoded",h.data=h.data?{entity:h.data}:{}),r.emulateHTTP&&("PUT"===s||"DELETE"===s||"PATCH"===s)){h.type="POST",r.emulateJSON&&(h.data._method=s);var a=r.beforeSend;r.beforeSend=function(t){if(t.setRequestHeader("X-HTTP-Method-Override",s),a)return a.apply(this,arguments)}}"GET"===h.type||r.emulateJSON||(h.processData=!1);var u=r.error;r.error=function(t,e,i){r.textStatus=e,r.errorThrown=i,u&&u.call(r.context,t,e,i)};var c=r.xhr=t.Xhr.request(t.mixin(h,r));return n.trigger("request",n,c,r),c},Entity:n,Collection:r}),o});
//# sourceMappingURL=sourcemaps/models.js.map
